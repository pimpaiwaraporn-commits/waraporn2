import numpy as np
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import Axes3D # ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 3D
import streamlit as st 

# ====================
# ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏≠‡∏õ Streamlit ‡πÅ‡∏•‡∏∞ Control Widgets
# ====================
st.set_page_config(layout="wide") # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏ï‡πá‡∏°
st.title('üåå ‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏™‡∏ô‡∏≤‡∏°‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÑ‡∏î‡πÇ‡∏û‡∏• 3 ‡∏°‡∏¥‡∏ï‡∏¥ (3D Electric Dipole Field)')
st.write('‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡∏ô‡∏≤‡∏°‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÉ‡∏ô‡∏õ‡∏£‡∏¥‡∏†‡∏π‡∏°‡∏¥ 3 ‡∏°‡∏¥‡∏ï‡∏¥ (X, Y, Z)')

# ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°
st.sidebar.header('‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á')
n_points = st.sidebar.slider('‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î (N)', 5, 15, 8) # ‡∏•‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
quiver_length = st.sidebar.slider('‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏•‡∏π‡∏Å‡∏®‡∏£ (Length)', 0.05, 0.5, 0.2, 0.05)
normalize_vectors = st.sidebar.radio('Normalize ‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå (‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å)', ('Yes', 'No'), index=0)

# ====================
# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ô‡∏≤‡∏°‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (E-Field Calculation Function)
# ====================

def calculate_e_field(charge_pos, X, Y, Z, sign=1):
    """‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏™‡∏ô‡∏≤‡∏°‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ (Ex, Ey, Ez) ‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏∏‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß"""
    
    # ‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ó‡∏ò‡πå (R)
    R_x = X - charge_pos[0]
    R_y = Y - charge_pos[1]
    R_z = Z - charge_pos[2]

    # ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏¢‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≠‡∏á (r^2)
    R_sq = R_x**2 + R_y**2 + R_z**2
    
    # ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏∏ (Coulomb's Law singularity)
    # ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ code ‡∏£‡∏±‡∏ô‡πÑ‡∏î‡πâ ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏∏
    R_sq[R_sq < 1e-6] = 1e-6

    # ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏ô‡∏≤‡∏° E = (sign * k * q) / r^2.5 (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ E_vec = E_mag * R_vec)
    # ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà k ‡πÅ‡∏•‡∏∞ q ‡∏ñ‡∏π‡∏Å‡∏•‡∏∞‡πÑ‡∏ß‡πâ (implied = 1) ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°
    E_mag = sign / R_sq**1.5 

    # ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡∏ô‡∏≤‡∏° (E = E_mag * R)
    E_x = E_mag * R_x
    E_y = E_mag * R_y
    E_z = E_mag * R_z
    return E_x, E_y, E_z

# ====================
# ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° (Main Logic)
# ====================

# 1. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏∏ (Electric Dipole)
q_pos = np.array([0.5, 0, 0])  # ‡∏õ‡∏£‡∏∞‡∏à‡∏∏‡∏ö‡∏ß‡∏Å
q_neg = np.array([-0.5, 0, 0]) # ‡∏õ‡∏£‡∏∞‡∏à‡∏∏‡∏•‡∏ö
span = 1.5

# 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Mesh Grid ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î
x_lim = np.linspace(-span, span, n_points)
y_lim = np.linspace(-span, span, n_points)
z_lim = np.linspace(-span, span, n_points)
X, Y, Z = np.meshgrid(x_lim, y_lim, z_lim)

# 3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ô‡∏≤‡∏°‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏£‡∏ß‡∏°
E_pos_x, E_pos_y, E_pos_z = calculate_e_field(q_pos, X, Y, Z, sign=1)
E_neg_x, E_neg_y, E_neg_z = calculate_e_field(q_neg, X, Y, Z, sign=-1)

# ‡∏™‡∏ô‡∏≤‡∏°‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏£‡∏ß‡∏° (Superposition Principle)
U = E_pos_x + E_neg_x
V = E_pos_y + E_neg_y
W = E_pos_z + E_neg_z

# ====================
# 4. ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏î‡πâ‡∏ß‡∏¢ Quiver Plot 3D
# ====================

fig = plt.figure(figsize=(10, 8))
# ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î projection='3d' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡∏ô 3 ‡∏°‡∏¥‡∏ï‡∏¥
ax = fig.add_subplot(111, projection='3d') 

# ‡∏ß‡∏≤‡∏î Quiver Plot
ax.quiver(
    X, Y, Z,
    U, V, W,
    length=quiver_length, # ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Slider
    normalize=(normalize_vectors == 'Yes'), # ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Radio Button
    color='purple',
    alpha=0.7
)

# ‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏∏
ax.scatter(q_pos[0], q_pos[1], q_pos[2], color='red', marker='o', s=100, label='+ Charge')
ax.scatter(q_neg[0], q_neg[1], q_neg[2], color='blue', marker='o', s=100, label='- Charge')

# 5. ‡∏Å‡∏≤‡∏£‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á
ax.set_title('3D Electric Dipole Field', fontsize=16)
ax.set_xlabel('X Axis')
ax.set_ylabel('Y Axis')
ax.set_zlabel('Z Axis')
ax.set_xlim([-span, span])
ax.set_ylim([-span, span])
ax.set_zlim([-span, span])
ax.legend()
ax.view_init(elev=20, azim=120) # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

# 6. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô Streamlit
st.pyplot(fig) 

st.caption(f"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: {n_points**3} ‡∏à‡∏∏‡∏î")
st.warning("‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏°‡∏Å‡∏≤‡∏£ $E \propto R/r^{3}$ (‡πÄ‡∏ß‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå) ‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≤‡∏á‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå $k$ ‡πÅ‡∏•‡∏∞ $q$ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÄ‡∏£‡∏Ç‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô")
